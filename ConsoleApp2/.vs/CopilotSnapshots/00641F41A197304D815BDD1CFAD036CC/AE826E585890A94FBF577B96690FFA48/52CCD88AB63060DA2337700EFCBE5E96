using System;
using ConsoleApp2.Models;
using ConsoleApp2.Services;
using ConsoleApp2.Transactions;

namespace ConsoleApp2.Models
{
    public static class ExtensionMethods
    {
        /// <summary>
        /// Kart nömrəsini 1234 **** **** 5678 formatında mask edir
        /// </summary>
        public static string MaskCardNumber(this Card card)
        {
            if (string.IsNullOrEmpty(card.CardNumber) || card.CardNumber.Length != 16)
                return card.CardNumber ?? string.Empty;
            
            return $"{card.CardNumber.Substring(0, 4)} **** **** {card.CardNumber.Substring(12, 4)}";
        }
        
        /// <summary>
        /// Xərclənən məbləğə görə bonus hesablayır və kartdan pul çıxarır
        /// TransactionService ilə tranzaksiya qeyd edir
        /// </summary>
        public static bool ExpenseAndGetBonus(this Card card, double amount, TransactionService? transactionService = null)
        {
            if (amount <= 0)
                return false;
                
            // Kartdan pul çıxarma cəhdi
            if (!card.WithDraw(amount))
                return false;
            
            // Bank tipinə görə bonus hesablama
            double bonusPercentage = card.Bank switch
            {
                Bank.ABB => 0.02,      // 2%
                Bank.Leo => 0.04,      // 4%
                Bank.Kapital => 0.05,  // 5%
                _ => 0.0
            };
            
            // Bonusu əlavə et
            card.Bonus += amount * bonusPercentage;
            
            // Tranzaksiya qeyd et
            if (transactionService != null)
            {
                var transaction = new Transaction
                {
                    Id = new Random().Next(1000, 9999), // Sadə ID yaratma
                    CardNumber = card.CardNumber,
                    Amount = amount,
                    Date = DateTime.Now
                };
                
                try
                {
                    transactionService.AddTransaction(transaction);
                }
                catch
                {
                    // Tranzaksiya əlavə edilə bilməzsə, pul və bonusu geri qaytar
                    card.Balance += amount;
                    card.Bonus -= amount * bonusPercentage;
                    return false;
                }
            }
            
            return true;
        }
    }
}
